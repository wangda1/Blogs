---
title: 深度学习环境配置
date: 2020-09-18 22:01:00
categories:
- Something
tags:
- Something
---

# 深度学习环境配置

比较粗略的讲一次配置实验室机器环境的过程

环境：Ubuntu 18.04，Tesla V100-SXM2-32GB

## apt 源

将 apt 源设置到国内 阿里源，编辑文件：`/etc/apt/source.list`

```
deb http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse
  
deb-src http://mirrors.aliyun.com/ubuntu/ bionic main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ bionic-security main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ bionic-updates main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ bionic-backports main restricted universe multiverse

deb http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse

deb-src http://mirrors.aliyun.com/ubuntu/ bionic-proposed main restricted universe multiverse
```

```shell
sudo apt-get update
```

## GCC

GCC 是安装 nvidia 驱动的前提，装驱动的时候需要编译 kernel module

但 GCC 往往需要多个版本，因此安装多个版本的 GCC

```shell
sudo apt-get install gcc-5 g++-5
sudo apt-get install gcc-7 g++-7

ls /usr/bin/gcc*        # 查看已经安装的 GCC 版本

# 使用 udpate-alternatives 管理多个版本的 GCC，50/40 代表优先级
sudo update-alternatives  --install  /usr/bin/gcc gcc /usr/bin/gcc-5 50
sudo update-alternatives  --install  /usr/bin/gcc gcc /usr/bin/gcc-7 40
sudo update-alternatives  --install  /usr/bin/g++ g++ /usr/bin/g++-5 50
sudo update-alternatives  --install  /usr/bin/g++ g++ /usr/bin/g++-7 40
# sudo update-alternatives --remove gcc /usr/bin/gcc-5 # 删除对应的管理版本

# 选择 GCC，输入对应的数字
sudo update-alternatives --config gcc

# 选择 G++
sudo update-alternatives --config g++
```

## nvidia 驱动

- 查询设备信息
- 官网查找驱动
- gcc/dkms 安装正确
- sudo ./NVIDIA-Linux-x86_64-450.66.run

> 不能成功执行 `nvidia-smi` 命令多半是驱动问题！！！

驱动安装之前，通过 `lspci | grep -i nvidia` 查到的是 nvidia 设备信息如下，根据 `1bd5` 到 https://download.nvidia.com/XFree86/Linux-x86_64/396.45/README/supportedchips.html 查找对应的设备型号，https://www.nvidia.com/Download/Find.aspx 下载对应的设备驱动

```
1a:00.0 3D controller: NVIDIA Corporation Device 1db5 (rev a1)
```

其它相关命令

```shell
cat /proc/driver/nvidia/version     # 查看当前驱动版本
```

注：安装过程中需要保证 GCC version >= 驱动提示的 GCC version，本机使用：
- NVIDIA-Linux-x86_64-450.66.run
- gcc 7.5

## CUDA

*cuda 安装的前提仍需要 gcc*

cuda 的安装只需要根据自己所需的版本到 https://developer.nvidia.com/cuda-downloads 找到对应的 runfile，下载本地安装即可

只需要一路回车，将 cuda 安装在了 /usr/local/cuda-x 目录（此路径可以改）

本机使用：
- cuda_9.0.176_384.81_linux.run
- gcc 5.5

## conda

- 下载安装文件，安装即可

下载安装文件的地址：https://www.anaconda.com/products/individual#linux

```shell
# 查看源
conda config --show-sources

# 添加 conda 国内源

# 添加清华的源
conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/
# 中科大的源
conda config –add channels https://mirrors.ustc.edu.cn/anaconda/pkgs/free/ 

# 移除源
conda config --remove channels

# conda安装包的时候指定源
conda install cudatoolkit=8.0 -c https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/linux-64/
```

## cudnn 的安装 

在 https://blog.csdn.net/yuejisuo1948/article/details/81043962 查看 cuda 和 cudnn 对应的版本

在 https://developer.nvidia.com/rdp/cudnn-archive 下载对应的安装文件，安装即可（这一步下载可能需要 log in ）

## tensorflow/torch

使用 `pip` 安装即可，注意 tensorflow 对应的 cuda 版本问题

常见错误：

> ImportError: libcublas.so.9.0: cannot open shared object file: No such file or directory

```shell
# vim .bashrc
export PATH=$PATH:/usr/local/cuda/bin
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/cuda/lib64
export LIBRARY_PATH=$LIBRARY_PATH:/usr/local/cuda/lib64
```